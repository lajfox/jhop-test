<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
	xmlns:mvc="http://www.springframework.org/schema/mvc" xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
		http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

	<!-- 自动扫描且只扫描@Controller -->
	<context:component-scan base-package="com.techstar"
		use-default-filters="false">
		<context:include-filter type="annotation"
			expression="org.springframework.stereotype.Controller" />
	</context:component-scan>

	<mvc:annotation-driven conversion-service="conversionService">
		<mvc:argument-resolvers>
			<bean
				class="com.techstar.modules.springframework.web.JqgridSortArgumentResolver" />
			<bean
				class="com.techstar.modules.springframework.web.JqgridPageableArgumentResolver" />
			<bean
				class="com.techstar.modules.springframework.web.JqgridSpecificationArgumentResolver" >
				<property name="entityManagerFactory" ref="entityManagerFactory"/>
			</bean>
			<bean
				class="com.techstar.modules.springframework.web.method.annotation.PreModelAttributeMethodProcessor" >
					<property name="entityManagerFactory" ref="entityManagerFactory"/>
			</bean>
			<bean
				class="com.techstar.modules.springframework.web.method.annotation.PreparableMethodProcessor" >
					<property name="entityManagerFactory" ref="entityManagerFactory"/>
			</bean>
			<bean
				class="com.techstar.modules.springframework.web.method.annotation.PrePathVariableMethodArgumentResolver" />
			<bean
				class="com.techstar.modules.springframework.web.JqgridRowBoundsArgumentResolver" />
			<bean
				class="com.techstar.modules.springframework.web.JqgridQuerySpecificationArgumentResolver" />
			<bean
				class="com.techstar.modules.springframework.web.JqgridQLSpecificationArgumentResolver" />
				
			<bean
				class="com.techstar.modules.jasperreports.web.JasperSpecificationArgumentResolver" />				
		</mvc:argument-resolvers>
		
		<mvc:return-value-handlers>
			<!-- json的mime为：application/json,ie6、ie7、ie8不支持application/json,一解析认为是文件，提示下载,将mime改为text/plain、text/html、text/json -->
			<bean
				class="com.techstar.modules.springframework.web.servlet.mvc.method.annotation.RequestIeResponseBodyMethodProcessor" >
				<constructor-arg index="0">
					<list>
						<bean class="org.springframework.http.converter.ByteArrayHttpMessageConverter"/>						
					</list>					
				</constructor-arg>
				<constructor-arg type="org.springframework.web.accept.ContentNegotiationManager"
					index="1">
					<ref bean="mvcContentNegotiationManager" />
				</constructor-arg>				
			</bean>		
		</mvc:return-value-handlers>		

		<mvc:message-converters>
			<bean
				class="com.techstar.modules.springframework.http.converter.xml.Jaxb2RootElementHttpMessageConverter" />
			<!-- 指定 charset为UTF-8，解决中文乱码-->	
 			<bean class = "org.springframework.http.converter.StringHttpMessageConverter">   
                <property name = "supportedMediaTypes">
                      <list>
                          <value>text/html;charset=UTF-8</value>   
                          <value>text/plain;charset=UTF-8</value>
                     </list>   
                </property>   
             </bean>   
             				
		</mvc:message-converters>
	</mvc:annotation-driven>


	<bean id="conversionService"
		class="org.springframework.format.support.FormattingConversionServiceFactoryBean">
		<property name="converters">
			<list>
				<bean
					class="com.techstar.modules.springframework.convert.converter.StringConverter" />
				<bean
					class="com.techstar.modules.springframework.convert.converter.DateConverter" />
				<bean
					class="com.techstar.modules.springframework.convert.converter.CommonsMultipartFileConverter" />					
			</list>
		</property>
	</bean>



	<!-- 将无法mapping到Controller的path交给default servlet handler处理 -->
	<mvc:default-servlet-handler />


	<!-- Jasperreports view配置 -->
	<bean id="japerreportsViewResolver" class="org.springframework.web.servlet.view.XmlViewResolver"> 
		<property name="order" value="0"/> <property name="location" value="/WEB-INF/jasperreports.xml"/> 
		</bean>

<!-- 	<bean id="jasperReportsViewResolver"
		class="org.springframework.web.servlet.view.jasperreports.JasperReportsViewResolver">
		<property name="order" value="0"></property>
		<property name="viewClass"
			value="org.springframework.web.servlet.view.jasperreports.MyJasperReportsMultiFormatView" />
		<property name="prefix" value="/WEB-INF/jasper/" />
		<property name="suffix" value=".jasper" />
		<property name="viewNames" value="rpt*" />
		<property name="jdbcDataSource" ref="dataSource" />
		<property name="exporterParameters">
			<map>			 	
				<entry
					key="net.sf.jasperreports.engine.JRExporterParameter.CHARACTER_ENCODING"
					value="utf-8" />
				<entry
					key="net.sf.jasperreports.engine.export.JRHtmlExporterParameter.IMAGES_URI"
					value="/sdjpa/report/image?image=" />
				<entry
					key="net.sf.jasperreports.engine.export.JRHtmlExporterParameter.IS_USING_IMAGES_TO_ALIGN"
					value="true" />
			</map>
		</property>
	</bean> -->

	<!-- 定义JSP文件的位置 -->
	<bean
		class="org.springframework.web.servlet.view.InternalResourceViewResolver">
		<property name="prefix" value="/WEB-INF/views/" />
		<property name="suffix" value=".jsp" />
	</bean>

	<!-- 定义无Controller的path<->view直接映射 -->
	<mvc:view-controller path="/" view-name="index" />
	<mvc:view-controller path="/ajaxlogin" view-name="ajaxlogin" />
	<mvc:view-controller path="/iframe" view-name="iframe" />

	<!-- 让springmvc支持文件上传 -->
	<bean id="multipartResolver"
		class="org.springframework.web.multipart.commons.CommonsMultipartResolver">
		<property name="maxInMemorySize" value="2048"></property>
		<property name="maxUploadSize" value="11485760000" />
		<property name="uploadTempDir" value="tmp"></property>
	</bean>


	<!-- 支持 Shiro对Controller的方法级AOP安全控制 begin -->
	<bean
		class="org.springframework.aop.framework.autoproxy.DefaultAdvisorAutoProxyCreator"
		depends-on="lifecycleBeanPostProcessor">
		<property name="proxyTargetClass" value="true" />
	</bean>

	<bean
		class="org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor">
		<property name="securityManager" ref="securityManager" />
	</bean>
	<!-- 支持 Shiro对Controller的方法级AOP安全控制 end -->

	<bean
		class="com.techstar.modules.shiro.web.servlet.handler.ShiroMappingExceptionResolver">
		<property name="exceptionMappings">
			<props>
				<prop key="org.springframework.validation.BindException">error/400</prop>
				<prop key="org.apache.shiro.authz.UnauthorizedException">error/403</prop>
				<prop key="java.lang.Throwable">error/500</prop>
			</props>
		</property>
		<property name="statusCodes">
			<props>
				<prop key="error/500">500</prop>
			</props>
		</property>
	</bean>
	
	<import resource="spring-controller.xml" />	

</beans>
